<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>074 & 0xx Face Recognition FP AI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom styles for result display */
      .result-item {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        border-bottom: 1px solid #e5e7eb; /* gray-200 */
      }
      .result-item:last-child {
        border-bottom: none;
      }
      .result-label {
        font-weight: 600;
        color: #4b5563; /* gray-600 */
      }
      .result-value {
        color: #1f2937; /* gray-800 */
      }
      .similarity-bar-container {
        width: 100%;
        background-color: #e5e7eb; /* gray-200 */
        border-radius: 0.25rem;
        overflow: hidden;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .similarity-bar {
        height: 1.25rem; /* h-5 */
        background-color: #3b82f6; /* blue-500 */
        text-align: center;
        line-height: 1.25rem; /* leading-5 */
        color: white;
        font-weight: bold;
        transition: width 0.5s ease-in-out;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-5">
      <h1 class="text-3xl font-bold text-center mb-8 text-blue-700">
        Face Recognition App
      </h1>
      <div class="w-full max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
        <div class="mb-6 border-b border-gray-200">
          <nav class="flex space-x-4" aria-label="Tabs">
            <button
              id="tab-upload"
              class="py-2 px-4 text-blue-600 border-b-2 border-blue-600 font-semibold focus:outline-none"
              onclick="showTab('uploadTab')"
            >
              Upload Images
            </button>
            <button
              id="tab-webcam"
              class="py-2 px-4 text-gray-600 hover:text-blue-600 border-b-2 border-transparent font-semibold focus:outline-none"
              onclick="showTab('webcamTab')"
            >
              Webcam Recognition
            </button>
          </nav>
        </div>

        <!-- Tab 1: Upload Images -->
        <div id="uploadTab" class="tab-content">
          <h2 class="text-xl font-semibold mb-4 text-gray-700">
            Upload Two Images for Similarity Prediction
          </h2>
          <form id="imageUploadForm" enctype="multipart/form-data">
            <div class="mb-4">
              <label for="modelSelectUpload" class="block text-gray-700 mb-1"
                >Select Model:</label
              >
              <select
                id="modelSelectUpload"
                name="model_name"
                class="block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-white"
              >
                <option value="VGG-Face" selected>VGG-Face</option>
                <option value="Facenet512">Facenet512</option>
                <option value="ArcFace">ArcFace</option>
                <option value="SFace">SFace</option>
                <option value="Facenet">Facenet</option>
                <option value="OpenFace">OpenFace</option>
                <option value="DeepFace">DeepFace</option>
                <option value="DeepID">DeepID</option>
                <option value="GhostFaceNet">GhostFaceNet</option>
              </select>
            </div>
            <div class="mb-4 flex gap-4">
              <div class="flex-1">
                <label class="block text-gray-700 mb-1">Image 1:</label>
                <input
                  type="file"
                  name="image1"
                  id="image1"
                  accept="image/*,.heic,.heif"
                  class="block w-full border border-gray-300 rounded-md shadow-sm p-2"
                  required
                />
                <img
                  id="preview1"
                  class="mt-2 rounded shadow max-h-40 mx-auto hidden"
                />
              </div>
              <div class="flex-1">
                <label class="block text-gray-700 mb-1">Image 2:</label>
                <input
                  type="file"
                  name="image2"
                  id="image2"
                  accept="image/*,.heic,.heif"
                  class="block w-full border border-gray-300 rounded-md shadow-sm p-2"
                  required
                />
                <img
                  id="preview2"
                  class="mt-2 rounded shadow max-h-40 mx-auto hidden"
                />
              </div>
            </div>
            <button
              type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded w-full font-semibold"
            >
              Predict Similarity
            </button>
          </form>
          <div id="loadingUpload" class="flex justify-center mt-4 hidden">
            <svg
              class="animate-spin h-8 w-8 text-blue-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V8z"
              ></path>
            </svg>
          </div>
          <div id="resultUpload" class="mt-5 text-gray-800"></div>
          <div
            id="verdictUpload"
            class="mt-2 text-lg font-semibold text-center"
          ></div>
        </div>

        <!-- Tab 2: Webcam Recognition -->
        <div id="webcamTab" class="tab-content hidden">
          <h2 class="text-xl font-semibold mb-4 text-gray-700">
            Webcam Face Recognition
          </h2>
          <form id="webcamForm" enctype="multipart/form-data">
            <div class="mb-4">
              <label for="modelSelectWebcam" class="block text-gray-700 mb-1"
                >Select Model:</label
              >
              <select
                id="modelSelectWebcam"
                name="model_name_webcam"
                class="block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-white"
              >
                <option value="VGG-Face" selected>VGG-Face</option>
                <option value="Facenet512">Facenet512</option>
                <option value="ArcFace">ArcFace</option>
                <option value="SFace">SFace</option>
                <option value="Facenet">Facenet</option>
                <option value="OpenFace">OpenFace</option>
                <option value="DeepFace">DeepFace</option>
                <option value="DeepID">DeepID</option>
                <option value="GhostFaceNet">GhostFaceNet</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 mb-1">Reference Image:</label>
              <input
                type="file"
                name="reference"
                id="referenceImageWebcam"
                accept="image/*,.heic,.heif"
                class="block w-full border border-gray-300 rounded-md shadow-sm p-2"
                required
              />
              <img
                id="webcamRefPreview"
                class="mt-2 rounded shadow max-h-40 mx-auto hidden"
              />
            </div>
            <div class="mb-4 flex flex-col items-center">
              <video
                id="webcamVideo"
                class="border border-gray-300 rounded-md mb-2"
                width="320"
                height="240"
                autoplay
                playsinline
              ></video>
              <canvas
                id="webcamCanvas"
                width="320"
                height="240"
                class="hidden"
              ></canvas>
              <button
                type="button"
                id="captureBtn"
                class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded font-semibold mt-2"
              >
                Capture & Predict
              </button>
            </div>
          </form>
          <div id="loadingWebcam" class="flex justify-center mt-4 hidden">
            <svg
              class="animate-spin h-8 w-8 text-green-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V8z"
              ></path>
            </svg>
          </div>
          <div id="resultWebcam" class="mt-5 text-gray-800"></div>
          <div
            id="verdictWebcam"
            class="mt-2 text-lg font-semibold text-center"
          ></div>
        </div>
      </div>
    </div>

    <script>
      // Tab switching logic
      function showTab(tabId) {
        document.getElementById("uploadTab").classList.add("hidden");
        document.getElementById("webcamTab").classList.add("hidden");
        document.getElementById(tabId).classList.remove("hidden");
        const tabs = ["upload", "webcam"];
        tabs.forEach((tab) => {
          const button = document.getElementById(`tab-${tab}`);
          const isCurrentTab = `${tab}Tab` === tabId;
          button.classList.toggle("text-blue-600", isCurrentTab);
          button.classList.toggle("border-blue-600", isCurrentTab);
          button.classList.toggle("text-gray-600", !isCurrentTab);
          button.classList.toggle("border-transparent", !isCurrentTab);
        });
        if (tabId === "webcamTab" && !stream) {
          startWebcam();
        }
      }
      showTab("uploadTab");

      function previewImage(input, previewId) {
        const file = input.files[0];
        const preview = document.getElementById(previewId);
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = "";
          preview.classList.add("hidden");
        }
      }
      document.getElementById("image1").addEventListener("change", function () {
        previewImage(this, "preview1");
      });
      document.getElementById("image2").addEventListener("change", function () {
        previewImage(this, "preview2");
      });
      document
        .getElementById("referenceImageWebcam")
        .addEventListener("change", function () {
          previewImage(this, "webcamRefPreview");
        });

      function displayResults(data, resultElementId, verdictElementId) {
        const resultElement = document.getElementById(resultElementId);
        const verdictElement = document.getElementById(verdictElementId);
        resultElement.innerHTML = "";
        verdictElement.textContent = "";

        if (data.error) {
          resultElement.innerHTML = `<p class="text-red-500 text-center font-semibold">${data.error}</p>`;
          return;
        }

        const {
          verified,
          distance,
          threshold,
          model,
          similarity_metric,
          similarity_percentage,
        } = data;

        let html = '<div class="bg-gray-50 p-3 rounded-md shadow-sm">';
        html += `<div class="result-item"><span class="result-label">Model Used:</span> <span class="result-value">${model}</span></div>`;
        html += `<div class="result-item"><span class="result-label">Distance:</span> <span class="result-value">${parseFloat(
          distance
        ).toFixed(4)}</span></div>`;
        html += `<div class="result-item"><span class="result-label">Threshold:</span> <span class="result-value">${parseFloat(
          threshold
        ).toFixed(4)}</span></div>`;
        html += `<div class="result-item"><span class="result-label">Similarity Metric:</span> <span class="result-value">${similarity_metric}</span></div>`;

        // Similarity Percentage Bar
        html += `<div class="mt-3 mb-1"><span class="result-label">Similarity Score:</span></div>`;
        html += `<div class="similarity-bar-container">`;
        html += `<div class="similarity-bar" style="width: ${similarity_percentage}%; background-color: ${
          verified ? "#10B981" : "#EF4444"
        };">${similarity_percentage}%</div>`; // green-500 or red-500
        html += `</div>`;

        html += `<div class="result-item mt-1"><span class="result-label">Verified:</span> <span class="result-value font-bold ${
          verified ? "text-green-600" : "text-red-600"
        }">${
          verified ? "Yes (Same Person)" : "No (Different Persons)"
        }</span></div>`;
        html += "</div>";
        resultElement.innerHTML = html;

        if (verified === true) {
          verdictElement.textContent = `✅ Verified as the same person with ${similarity_percentage}% similarity.`;
          verdictElement.className =
            "mt-2 text-lg font-semibold text-center text-green-600";
        } else if (verified === false) {
          verdictElement.textContent = `❌ Verified as different persons. Similarity score: ${similarity_percentage}%.`;
          verdictElement.className =
            "mt-2 text-lg font-semibold text-center text-red-600";
        }
      }

      document
        .getElementById("imageUploadForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          document.getElementById("loadingUpload").classList.remove("hidden");
          document.getElementById("resultUpload").innerHTML = "";
          document.getElementById("verdictUpload").textContent = "";
          const formData = new FormData(this);
          try {
            const response = await fetch("/predict", {
              method: "POST",
              body: formData,
            });
            const data = await response.json();
            displayResults(data, "resultUpload", "verdictUpload");
          } catch (error) {
            console.error("Error during upload prediction:", error);
            document.getElementById(
              "resultUpload"
            ).innerHTML = `<p class="text-red-500 text-center font-semibold">An unexpected error occurred. Check console.</p>`;
          } finally {
            document.getElementById("loadingUpload").classList.add("hidden");
          }
        });

      const video = document.getElementById("webcamVideo");
      const canvas = document.getElementById("webcamCanvas");
      const captureBtn = document.getElementById("captureBtn");
      let stream = null;

      async function startWebcam() {
        if (stream) return;
        try {
          // Coba dapatkan akses webcam dengan konfigurasi yang lebih fleksibel
          const constraints = {
            video: {
              width: { ideal: 320 },
              height: { ideal: 240 },
              facingMode: "user",
            },
          };

          stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;

          // Tambahkan event listener untuk menangani error video
          video.onerror = function (e) {
            console.error("Video error:", e);
            alert(
              "Terjadi kesalahan pada video. Silakan refresh halaman dan coba lagi."
            );
          };

          // Pastikan video sudah siap
          video.onloadedmetadata = function () {
            video.play();
          };
        } catch (err) {
          console.error("Webcam error:", err);
          let errorMessage = "Tidak dapat mengakses webcam. ";

          if (
            err.name === "NotAllowedError" ||
            err.name === "PermissionDeniedError"
          ) {
            errorMessage +=
              "Mohon berikan izin akses webcam di pengaturan browser Anda.";
          } else if (
            err.name === "NotFoundError" ||
            err.name === "DevicesNotFoundError"
          ) {
            errorMessage +=
              "Tidak ada webcam yang terdeteksi. Pastikan webcam Anda terhubung dengan benar.";
          } else if (
            err.name === "NotReadableError" ||
            err.name === "TrackStartError"
          ) {
            errorMessage +=
              "Webcam sedang digunakan oleh aplikasi lain. Silakan tutup aplikasi lain yang mungkin menggunakan webcam.";
          } else {
            errorMessage += "Silakan refresh halaman dan coba lagi.";
          }

          alert(errorMessage);
          stream = null;
        }
      }

      captureBtn.addEventListener("click", async function () {
        const refInput = document.getElementById("referenceImageWebcam");
        if (!refInput.files[0]) {
          alert("Please upload a reference image first.");
          return;
        }
        if (!stream) {
          alert("Webcam not started. Please allow access.");
          await startWebcam();
          if (!stream) return;
        }
        document.getElementById("loadingWebcam").classList.remove("hidden");
        document.getElementById("resultWebcam").innerHTML = "";
        document.getElementById("verdictWebcam").textContent = "";
        canvas
          .getContext("2d")
          .drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(async function (blob) {
          const formData = new FormData();
          formData.append("reference", refInput.files[0]);
          formData.append("webcam", blob, "webcam_capture.jpg");
          formData.append(
            "model_name",
            document.getElementById("modelSelectWebcam").value
          );
          try {
            const response = await fetch("/predict_webcam", {
              method: "POST",
              body: formData,
            });
            const data = await response.json();
            displayResults(data, "resultWebcam", "verdictWebcam");
          } catch (error) {
            console.error("Error during webcam prediction:", error);
            document.getElementById(
              "resultWebcam"
            ).innerHTML = `<p class="text-red-500 text-center font-semibold">An unexpected error occurred. Check console.</p>`;
          } finally {
            document.getElementById("loadingWebcam").classList.add("hidden");
          }
        }, "image/jpeg");
      });

      window.addEventListener("beforeunload", () => {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }
      });
    </script>
  </body>
</html>
